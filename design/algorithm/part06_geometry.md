# Расчет координат блоков на кране

**Цель** - рассчитать глобальные координаты центров блоков, установленных на стреле крана. Расчет основан на длине и угле наклона каждой стрелы, а также на локальных координатах блоков относительно начала стрел.

Схема крана включает в себя:

- **Две стрелы:**
  - `main boom` — основная стрела, длина обозначается: $L_{boom(1)}$
  - `knuckle boom` — складная стрела, длина обозначается $L_{boom(2)}$
- **5 блоков**
- **Барабан лебедки**

![Alt text to image](/assets/algorithm/update1.png)

## Входные данные

| Переменная         | Тип / Формат           | Описание                                                       |
|--------------------|------------------------|-----------------------------------------------------------------|
| $L_{boom(i)}$       | float (мм)             | Длина i-ой стрелы стрелы                                          |                                  |
| $\alpha_i$      | float (°)              | Угол между стрелами                    |        |            |
| $n$       |                int |         Количество стрел |     
| $i$     | int                 | Номер стрелы: `1` — `main boom`, `2` — `knuckle boom`          |
|$l_{1,i}$|float (мм)|**вертикальное расстояние** от точки до стрелы (перпендикуляр к оси стрелы).| 
|$l_{2,i}$|float (мм)|**горизонтальное расстояние** от перпендикуляорный проекции точки на стрелу до точки D или G (вдоль оси стрелы).|
|$X_0, Y_0$| float|начальная точка первой стрелы|



## Выходные данные

| Переменная  | Тип / Формат          | Описание                     |
| ----------- | --------------------- | ---------------------------- |


### Расчёт абсолютного угла наклона каждой стрелы

Поскольку каждая следующая стрела (звено) поворачивается относительно предыдущей, её ориентация в глобальной системе координат зависит от **накопленной суммы всех предыдущих углов**.

Исходные данные:  
$$\alpha = [\alpha_1, \alpha_2, \ldots, \alpha_n]$$ — массив углов между стрелами (в градусах), а для первой стрелы между стрелой и горизонтом

Эти углы снимаются с датчика и определяют, как повёрнута каждая стрела **относительно предыдущей**.  
  Например:
  - $\alpha_1$ — угол основной стрелы к горизонту,
  - $\alpha_2$ — угол второй стрелы относительно первой и т.д.

![Alt text to image](/assets/algorithm/angles.png)

#### Формула для абсолютного угла наклона стрелы к горизонту:

$$
\alpha_{boom_i} = \left( \sum_{i=1}^{n} \alpha_{i} \right) - 180 \cdot (i - 1)
$$

Где:
- $i$ — номер стрелы (1, 2, ...),
- $\alpha_i$ — угол между $i$-й стрелой и предыдущей (в градусах), для первой между стрелой и горизонтом.
- $\alpha_{boom_i}$ — угол $i$-й стрелы относительно горизонта.

 
#### Определение координат точки в повернутой системе координат

Если повернутая система координат повёрнута **против часовой стрелки**, то угол берётся со знаком **плюс (+)**.   Если **по часовой стрелке** — со знаком **минус (−)**.
Например коордианты 

$$
X_x(X_{x1}, Y_{x1}, \alpha_{boom_i}) = X_{x1} \cdot \cos(\alpha_{boom_i}) - Y_{x1} \cdot \sin(\alpha_{boom_i})
$$

$$
Y_x(X_{x1}, Y_{x1}, \alpha_{boom_i}) = X_{x1} \cdot \sin(\alpha_{boom_i}) + Y_{x1} \cdot \cos(\alpha_{boom_i})
$$

$$
XY_x =
\begin{bmatrix}
X_x \\
Y_x
\end{bmatrix}
$$

Где 
$X_{x1}, Y_{x1}$ - координаты в неповернутой СК 
$\alpha_{boom_i}$ - абсолютный угол между i-стрелой и горизонтом
$X_x, Y_x$ - координаты в повернутой СК
$XY_x$ - переменная с координатами точки $x$ в повернутой СК 


#### Определение начальной точки и конечной точик для каждой стрелы:

Примем:
$X_{start(i)}, Y_{start(i)} -$ начальная точка i - стрелы 
$X_{fin(i)}, Y_{fin(i)} -$ конечная точка i - стрелы 

- Для **первой стрелы** ($i = 1$) начальная точка известна заранее и совпадает с осью её поворота:

$$
X_{start(1)} = X_0, \quad Y_{start(i)} = Y_0
$$

- Для **последующих стрел** ($i > 1$) начальная точка совпадает с концом предыдущей стрелы, то есть с точкой $G_{i-1}$:

$$
X_{start(i)} = X_{fin(i-1)}, \quad Y_{start(i)} = Y_{fin(i-1)}
$$

$$
XY_{start(i)} =
\begin{bmatrix}
X_{start(i)}  \\
Y_{start(i)}
\end{bmatrix}
$$ 

Для каждой стрелы $i$ рассчитываются две ключевые точки:

#### Точка **D** (начало стрелы):

$$
D_i = XY_{start(i)} + XY_x(-l_{(2, i)},\quad l_{(1, i)}, \quad\alpha_{boom(i)})
$$

#### Точка **G** (конец стрелы):

$$
G_i = XY_{start(i)} + XY_x(L_{boom(1, i)} -l_{(2, i)},\quad l_{(1,i)}, \quad \alpha_{boom(i)})
$$

$$
T =
\begin{bmatrix}
D_i  \\
G_i
\end{bmatrix}
$$

Обозначения:

- $XY_{start(i)}$ — координаты начала стрелы $i$ 
- $XY_x()$ — координаты в повернутой системе координат 
---
> Эти точки используются для построения трансформационной матрицы $T_i$, описывающей положение стрелы $i$ в пространстве, а также для определения координат всех объектов, расположенных на этой стреле.
