# Расчет координат блоков на кране

**Цель** - рассчитать глобальные координаты центров блоков, установленных на стреле крана. Расчет основан на длине и угле наклона каждой стрелы, а также на локальных координатах блоков относительно начала стрел.

## Состав схемы крана
Схема крана включает в себя:

- **Две стрелы:**
  - `main boom` — основная стрела, длина обозначается: `l_mainboom`
  - `knuckle boom` — дополнительная стрела, длина обозначается: `l_knuckleboom`

- **Глобальная точка начала крана (барабан лебёдки):**
  - `X0_golbal`, `Y0_global`

- **5 блоков**, у каждого:
  - Локальные координаты: `Xi_local`, `Yi_local`
  - Глобальные координаты: `Xi_global`, `Yi_global`
  - Тип привязки: `K_turn[i]` = `"D"` (от начала стрелы) или `"G"` (от конца стрелы)
  - Номер стрелы: `block_arm[i]` = `1` или `2`

![Alt text to image](/assets/algorithm/update.png)
## Входные данные

| Переменная         | Тип / Формат           | Описание                                                       |
|--------------------|------------------------|-----------------------------------------------------------------|
| `l_mainboom`       | float (мм)             | Длина основной стрелы                                          |
| `l_knuckleboom`    | float (мм)             | Длина дополнительной стрелы                                    |
| `α_mainboom`       | float (°)              | Угол основной стрелы относительно горизонта                    |
| `α_knuckleboom`    | float (°)              | Угол дополнительной стрелы относительно основной стрелы        |
| `X0_global`, `Y0_global`| float (мм)             | Глобальные координаты точки отсчёта (начало крана)             |
| `K_turn[i]`         | "D" / "G"              | Откуда отсчитываются координаты блока: начало (`D`) или конец (`G`) стрелы |
| `block_arm[i]`     | 1 / 2                  | Номер стрелы: `1` — `main boom`, `2` — `knuckle boom`          |
| `Xi_local`, `Yi_local` | float (мм)         | Локальные координаты блока в системе своей стрелы              |


## Выходные данные

| Переменная  | Формат                | Описание                     |
| ----------- | --------------------- | ---------------------------- |
| `Xi_global`, `Yi_global` | float (мм)  | Глобальные координаты блоков |

## Расчет

### 1. Углы в радианах

**Перевод градусы в радианы** 

\[
\alpha_{main} = \alpha_{mainboom} \cdot \frac{\pi}{180}
\]

\[
\alpha_{knuckle} = (\alpha_{mainboom} + \alpha_{knuckleboom}) \cdot \frac{\pi}{180}
\]
### 2. Координаты концов стрел 
**Основная стрела (main boom):**

\[
X_{main\_end} = X_0 + l_{mainboom} \cdot \cos(\alpha_{main})
\]

\[
Y_{main\_end} = Y_0 + l_{mainboom} \cdot \sin(\alpha_{main})
\]

**Дополнительная стрела (knuckle boom):**

\[
X_{knuckle\_end} = X_{main\_end} + l_{knuckleboom} \cdot \cos(\alpha_{knuckle})
\]

\[
Y_{knuckle\_end} = Y_{main\_end} + l_{knuckleboom} \cdot \sin(\alpha_{knuckle})
\]

### 3. Расчет координат в повернутой системе координат

\[
\begin{cases}
X_i^{rot} = X_{i}^{local} \cdot \cos(\alpha) - Y_{i}^{local} \cdot \sin(\alpha) \\
Y_i^{rot} = X_{i}^{local} \cdot \sin(\alpha) + Y_{i}^{local} \cdot \cos(\alpha)
\end{cases}
\]

- \( X_i^{rot}, Y_i^{rot} \) — координаты блока после поворота (но ещё не в глобальной системе координат)
- \( \alpha \) — угол наклона стрелы к горизонту, рассчитывается следующим образом:

#### Угол наклона стрелы к горизонту (в градусах)

\[
\alpha = \left( \sum_{j=1}^{block\_arm[i]} \alpha_j \right) - 180 \cdot (block\_arm[i] - 1)
\]

#### Перевод в радианы

\[
\alpha = \alpha \cdot \frac{\pi}{180}
\]

Где:
- \( \alpha_j \) — угол поворота \( j \)-й стрелы относительно предыдущей (в градусах),
- \( block\_arm[i] \) — номер стрелы, на которой установлен блок.

> Углы считаются **накопительно**, т.е. каждая стрела повёрнута относительно предыдущей, а не напрямую к горизонту.


## 4. Точка отсчёта для блока

| Стрела         | `K_turn[i] = "D"` (начало стрелы)         | `K_turn[i] = "G"` (конец стрелы)           |
|----------------|-------------------------------------------|--------------------------------------------|
| main boom (1)  | \( (X_0, Y_0) \)                          | \( (X_{main\_end}, Y_{main\_end}) \)       |
| knuckle boom (2)| \( (X_{main\_end}, Y_{main\_end}) \)     | \( (X_{knuckle\_end}, Y_{knuckle\_end}) \) |


## 5. Расчет глобальных координат блоков

\[
X_i^{global} = X_{origin} + X_i^{rot}
\]

\[
Y_i^{global} = Y_{origin} + Y_i^{rot}
\]

где \( (X_{origin}, Y_{origin}) \) — точка отсчёта из таблицы выше.

## Итоговый алгоритм для каждого блока \(i\):

1. Вычислить угол \(\alpha\) в зависимости от стрелы.
2. Рассчитать повернутые координаты \(X_i^{rot}, Y_i^{rot}\).
3. Определить точку отсчёта \(X_{origin}, Y_{origin}\) в зависимости от `K_turn[i]` и `block_arm[i]`.
4. Получить глобальные координаты блока:
\[
(X_i^{global}, Y_i^{global}) = (X_{origin} + X_i^{rot}, \quad Y_{origin} + Y_i^{rot})
\]



