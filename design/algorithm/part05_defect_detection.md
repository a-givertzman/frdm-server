# Определение дефектов каната грузоподъёмного оборудования

## Общее описание 

Система предназначена для онлайн-диагностики каната грузоподъёмного оборудования с целью выявления дефектов и анализа степени его износа в процессе эксплуатации.

Основные задачи:

* непрерывный мониторинг каната;
* автоматическое выявление локальных дефектов;
* оценка степени износа на каждом участке;
* предоставление визуальной информации оператору в реальном времени.

Аппаратная часть:

* 4 камеры высокого разрешения, расположенные вокруг каната под углом 90°, на расстоянии 200 мм от поверхности каната;
* система освещения (светодиоды/прожекторы) для стабильной подсветки;
* вычислительный модуль для обработки изображений.

Общие
- длина каната 3000 м;
- скорость каната 150 м/мин;
скорость 

Короб

![Alt text to image](/assets/algorithm/короб.jpg)

Расположение короба на объекте

![Alt text to image](/assets/algorithm/короб_на_объекте.png)

Программная часть:

* бэкенд: алгоритмы обработки изображений, FastScan/FineScan, расчёт износа;
* фронтенд: графики износа, визуализация дефектов, доступ к изображениям.

## 1. Подготовка изображения

Этапы обработки кадров от камер:

### 1. Обрезка (cropping)
Обрезка рабочей зоны каната (исключение засветок и лишнего фона). 

### 2. Коррекция освещения
   * коррекция гаммы (компенсация низкой выдержки ~95 мкс);
   * автоматическая яркости и контрастности (растяжка гистограммы в заданных границах).

### 3. Сглаживание (Gaussian blur)

   **Суть метода:**

   Каждый пиксель изображения заменяется средневзвешенным значением окружающих пикселей, где веса распределяются по Гауссовому (нормальному) распределению. Пиксели ближе к центру имеют больший вес, чем удаленные.

   **Параметры размытия**

   - *Width и Height* - определяют размер матрицы (ядра), которая проходит по кадру и размывает его
   - *Sigma-x и Sigma-y*- устанавливают стандартное отклонение для матрицы:

      - Если *sigma-x и sigma-y* установлены в 0, они автоматически рассчитываются на основе размеров матрицы
      - Большее значение σ = сильнее размытие
      - Больший размер ядра = большее влияние соседних пикселей
   
   **Процесс применения**

   - Создается ядро свертки (матрица) с гауссовым распределением весов
   - Ядро применяется ко всему изображению методом свертки
   - Каждый пиксель заменяется взвешенной суммой соседних пикселей

### 4. Градиентный анализ:
Применение фильтра Собеля (вертикаль + горизонталь)

   **Суть метода:**
   Фильтр Собеля вычисляет приближенное значение производной яркости изображения в горизонтальном и вертикальном направлениях, показывая, где происходят резкие изменения интенсивности пикселей.

   **Как работает:**

   1) Применяются две матрицы свертки 3x3:

      Пусть А - исходное изображение
      - **Вертикальное ядро (Gx)** - обнаруживает горизонтальные границы
      
      $$
      Gx = 
      \begin{bmatrix}
      -1&0&+1 \\
      -2&0&+2 \\
      -1&0&+1\\
      \end{bmatrix}
      * A
      $$

      - **Горизонтальное ядро (Gy)** - обнаруживает вертикальные границы

      $$
      Gy =
      \begin{bmatrix}
      -1&-2&-1 \\
       0& 0& 0 \\
      +1&+2&+1 \\
      \end{bmatrix}
      * A
      $$
   где * - обозначает двумерную операцию свертки.

   2) Вычисление градиента:

      - Для каждого пикселя рассчитываются две производные: $Gx$ и $Gy$
      Как известно направление вектора градиента совпадает с направлением максимальной скорости изменения функции f в точке (x,y). 

      - Важную роль при обнаружении контуров играет модуль этого вектора, который обозначается $∇f$ и равен 
      $$∇f = \sqrt{Gx^2 + Gy^2}$$ 
      или упрощенно $$|Gx| + |Gy|$$

      - Далее вычисляется направление градиента: 
      $$θ = arctan(Gy/Gx)$$

   После Gaussian blur фильтр Собеля применяется для выделения границ каната. Сумма вертикальной и горизонтальной компонент (|Gx| + |Gy|) создает карту градиентов, где яркие области соответствуют краям каната, что затем используется для точного определения его контуров перед анализом дефектов.

### 5. Бинаризация
Пороговое преобразование в чёрно-белое изображение (порог статический или вычисляется автоматически). Для автоматического подбора оптимального порога бинаризации изображения применяется *метод Оцу (Otsu's Method)*.

   **Суть метода**:

   Метод находит такой порог, который максимизирует межклассовую дисперсию между двумя группами пикселей - фона и объекта. Другими словами, он старается сделать так, чтобы пиксели внутри каждой группы были как можно более "похожи" друг на друга, а группы максимально отличались между собой. Метод использует гистограмму изображения, где определяется порог для снижения внутриклассовой дисперсии.

![Alt text to image](/assets/algorithm/Otsu_method.png)


### Формулы метода Оцу

Метод Оцу ищет порог $t$, который **минимизирует внутриклассовую дисперсию** или **максимизирует межклассовую дисперсию**.

#### 1. Внутриклассовая дисперсия (Within-Class Variance)

Взвешенная сумма дисперсий двух классов:

$$
\sigma^2_w(t) = \omega_1(t) \sigma^2_1(t) + \omega_2(t) \sigma^2_2(t)
$$

где:
- $i$ — число, указывающее на класс пикселя, 
- веса $ω_i$ — это вероятности двух классов, разделённых порогом $t$
- $\sigma _{i}^{2}$ — дисперсия этих классов. 

#### 2. Межклассовая дисперсия (Between-Class Variance)

Альтернативный критерий:

$$
\sigma^2_b(t) = \omega_1(t) \omega_2(t) [\mu_1(t) - \mu_2(t)]^2
$$

В этой формуле $\mu_1(t)$  и $\mu_2(t)$  — средние арифметические значения для каждого из классов.

**Алгоритм:**

   - Вычисляем гистограмму (один проход через массив пикселей). Дальше нужна только гистограмма; проходов по всему изображению больше не требуется.

   - Начиная с порога t = 1, проходим через всю гистограмму, на каждом шаге пересчитывая дисперсию $\sigma^2_b(t)$. Если на каком-то из шагов дисперсия оказалась больше максимума, то обновляем дисперсию и T = t.

   - Искомый порог равен T.

**6. Выделение границ**: сканирование по столбцам пикселей, фиксация первого белого пикселя как границы каната.


## 2. Быстрое сканирование FastScan

**FastScan** - быстрая оценка контуров троса. Выполняется на каждом дискретном отрезке каната по мере поступления новых изображений с камер.

Алгоритм:

1. Построение профиля краёв каната.
2. Сравнение профиля с эталонным усреднённым значением.
3. Поиск аномалий:
   * выбросы пикселей за допустимые пределы,
   * локальные расширения/сужения диаметра.
4. Если аномалия превышает порог FastScan (определяемый в конфиге), участок помечается как повреждение.


## 3. Детализированное сканирование FineScan

FineScan запускается только на подозрительных участках, выявленных FastScan.

1. Определение типа дефекта:

   * Местное одностороннее расширение (асимметрия в одну сторону);
   * Местное расширение диаметра (симметричное утолщение);
   * Местное уменьшение диаметра (симметричное сужение);
   * Местное одностороннее уменьшение диаметра (асимметричное сужение).

## 4. Передача результата в бэкенд для записи и отображения.
Данные обновляются каждые 500 миллисекунд по кабелю Ethernet 


## 4. Фронтенд (Отображение инфорамции)

Интерфейс оператора обновляется каждые 500 мс и включает:

* График износа по длине каната (масштабирование, скроллинг, агрегация данных при отдалении);
* Метки дефектов (красные точки на графике);
* Просмотр фото дефектов: снимки с камер;
* Реальное время: данные подтягиваются непрерывно с сервера.

![Alt text to image](/assets/algorithm/app1.jpg)

![Alt text to image](/assets/algorithm/app2.jpg)

![Alt text to image](/assets/algorithm/app3.jpg)

![Alt text to image](/assets/algorithm/app4.jpg)

![Alt text to image](/assets/algorithm/app5.jpg)

## 6. Итоговая архитектура

![Alt text to image](/assets/algorithm/arch.jpg)
